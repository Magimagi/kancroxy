(function(){var Buffer,cache,config,fs,getOptions,http,local,processor,radical,sendHttpRequest,socks,storage,ui,url,util;http=require("http");socks=require("socksv5");fs=require("fs");url=require("url");local=require("shadowsocks");config=require("./config").config;Buffer=require("buffer").Buffer;processor=require("./processor");ui=require("./ui");util=require("./util");cache=require("./cache");storage=require("./storage");radical=require("./radical_storage");exports.createShadowsocksServer=function(){if(!config.proxy.useShadowsocks){return}local.createServer(config.proxy.shadowsocks.serverIp,config.proxy.shadowsocks.serverPort,config.proxy.shadowsocks.localPort,config.proxy.shadowsocks.password,config.proxy.shadowsocks.method,config.proxy.shadowsocks.timeout,"127.0.0.1");return util.log("Shadowsocks @ 127.0.0.1:"+config.proxy.shadowsocks.localPort)};exports.createServer=function(){var server;server=http.createServer(function(req,res){var getCache,options,parsed,postData;parsed=url.parse(req.url);options=getOptions(req,parsed);getCache=false;if(config.cache.useStorage&&req.method==="GET"&&util.isCacheUrl(req.url)){getCache=storage.loadStorageFile(req,res)}if(getCache){return}if(config.cache.useRadical&&req.method==="GET"&&util.isCacheUrl(req.url)){getCache=radical.loadStorageFile(req,res)}if(getCache){return}postData="";req.setEncoding("utf8");req.addListener("data",function(chunk){return postData+=chunk});return req.addListener("end",function(){options.postData=req.postData=postData;return sendHttpRequest(options,0,function(result){var buffers;if(result.err){res.writeHead(500,{"Content-Type":"text/html"});res.write("<!DOCTYPE html><html><body><h1>Network Error</h1></body></html>");return res.end()}else{buffers=[];result.on("data",function(chunk){return buffers.push(chunk)});return result.on("end",function(){var data,err,_ref;data=Buffer.concat(buffers);result.removeAllListeners("data");result.removeAllListeners("end");if(req.url==="http://www.dmm.com/netgame/social/-/gadgets/=/app_id=854854/"){try{return util.modifyPage(data,((_ref=result.headers["content-encoding"])!=null?_ref.indexOf("gzip"):void 0)!==-1,function(modifyResult){result.headers["content-length"]=modifyResult.length;res.writeHead(result.statusCode,result.headers);res.write(modifyResult);return res.end()})}catch(_error){err=_error;res.writeHead(result.statusCode,result.headers);res.write(data);return res.end()}}else{res.writeHead(result.statusCode,result.headers);res.write(data);res.end();try{if(req.url.indexOf("/kcsapi")!==-1){processor.processData(req,data)}if(config.cache.useStorage&&req.method==="GET"&&result.statusCode===200&&util.isCacheUrl(req.url)){return storage.saveStorageFile(req,data)}}catch(_error){err=_error;return util.log(err)}}})}})})});server.listen(config.poi.listenPort);return util.log("Poi Proxy @ 127.0.0.1:"+config.poi.listenPort)};getOptions=function(req,parsed){var options,socksConfig;options=null;if(config.proxy.useShadowsocks){util.log("正在使用Shadowsocks代理"+req.method+" "+req.url);socksConfig={proxyHost:"127.0.0.1",proxyPort:config.proxy.shadowsocks.localPort,auths:[socks.auth.None()]};options={host:parsed.host||"127.0.0.1",hostname:parsed.hostname||"127.0.0.1",port:parsed.port||80,method:req.method,path:parsed.path||"/",headers:req.headers,agent:new socks.HttpAgent(socksConfig)}}else if(config.proxy.useSocksProxy){util.log("正在使用Socks5代理"+req.method+" "+req.url);socksConfig={proxyHost:config.proxy.socksProxy.socksProxyIp,proxyPort:config.proxy.socksProxy.socksProxyPort,auths:[socks.auth.None()]};options={host:parsed.host||"127.0.0.1",hostname:parsed.hostname||"127.0.0.1",port:parsed.port||80,method:req.method,path:parsed.path||"/",headers:req.headers,agent:new socks.HttpAgent(socksConfig)}}else if(config.proxy.useHttpProxy){util.log("正在使用HTTP代理"+req.method+" "+req.url);options={host:config.proxy.httpProxy.httpProxyIP,port:config.proxy.httpProxy.httpProxyPort,method:req.method,path:req.url,headers:req.headers}}else{util.log("正在使用全局默认连接方式"+req.method+" "+req.url);options={host:parsed.host||"127.0.0.1",hostname:parsed.hostname||"127.0.0.1",port:parsed.port||80,method:req.method||"GET",path:parsed.path||"/",headers:req.headers}}return options};sendHttpRequest=function(options,counter,callback){var err,request;try{request=http.request(options,function(result){if((options.path.indexOf("/kcsapi/")!==-1||options.path.indexOf("/kcs/")!==-1)&&(result.statusCode===500||result.statusCode===502||result.statusCode===503)){util.log("HTTP "+result.statusCode+" 正在进行第"+counter+"次重试");if(counter!==config.antiCat.retryTime){ui.addAntiCatCounter();return setTimeout(function(){return sendHttpRequest(options,counter+1,callback)},config.antiCat.retryDelay)}else{return callback({err:true})}}else{return callback(result)}});if(options.method==="POST"&&options.postData){request.write(options.postData)}request.on("error",function(e){if(!(options.path.indexOf("/kcsapi/")!==-1||options.path.indexOf("/kcs/")!==-1)){return}util.log("错误 "+e+" 正在进行第"+counter+"次重试");if(counter!==config.antiCat.retryTime){ui.addAntiCatCounter();return setTimeout(function(){return sendHttpRequest(options,counter+1,callback)},config.antiCat.retryDelay)}else{return callback({err:true})}});return request.end()}catch(_error){err=_error;util.log(err);if(counter!==config.antiCat.retryTime){ui.addAntiCatCounter();return setTimeout(function(){return sendHttpRequest(options,counter+1,callback)},config.antiCat.retryDelay)}else{return callback({err:true})}}}}).call(this);