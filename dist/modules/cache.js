(function(){var cacheData,fs,resVersionPath,resVersionRealPath,url,util;fs=require("fs");url=require("url");util=require("./util");resVersionPath="data/static_res.json";resVersionRealPath=global.appDataPath+"/"+resVersionPath;cacheData={};exports.initCache=function(){var data,err,res,_i,_len,_ref,_results;try{data=JSON.parse(fs.readFileSync(resVersionRealPath))}catch(_error){err=_error;if(err){console.log(err)}data=JSON.parse(fs.readFileSync(resVersionPath));util.copyFile(resVersionPath,resVersionRealPath)}_ref=data.list;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){res=_ref[_i];_results.push(cacheData[res.res_path]=res)}return _results};exports.loadCacheFile=function(req,res,callback){var cacheInfo,cacheSize,cacheVersion,fileAbsolutePath,filePath,query,requestVersion;if(req.url.indexOf("/kcs/Core.swf")!==-1||req.url.indexOf("/kcs/mainD2.swf")!==-1){callback(true);return}if(req.url.indexOf("/kcs/")!==-1){filePath=url.parse(req.url).pathname;query=url.parse(req.url).query;requestVersion=1;if(query!=null){requestVersion=query.substr("VERSION=".length)}cacheInfo=cacheData[filePath];if(cacheInfo==null||requestVersion==null){callback(true);return}cacheSize=cacheInfo.file_size;cacheVersion=cacheInfo.version;if(cacheSize==null){callback(true);return}fileAbsolutePath=""+global.appDataPath+filePath;return fs.stat(fileAbsolutePath,function(err,stat){var fileSize;if(err==null){fileSize=stat.size;if(fileSize!==cacheSize){callback(true);return}return fs.readFile(fileAbsolutePath,function(err,data){var date;if(!err){date=(new Date).toGMTString();res.writeHead(200,'{ "date":"'+date+'", "server":"Apache", "last-modified":"Wed, 23 Apr 2014 05:46:42 GMT", "accept-ranges":"bytes", "content-length":"'+fileSize+'", "cache-control":"max-age=2592000, public", "connection":"close", "content-type":"application/x-shockwave-flash" }');res.write(data);res.end();return callback(false)}else{console.log(err);return callback(true)}})}else{console.log(err);return callback(true)}})}else{return callback(true)}};exports.saveCacheFile=function(req,data){var fileAbsolutePath,filePath;if(req.url.indexOf("/kcs/Core.swf")!==-1||req.url.indexOf("/kcs/mainD2.swf")!==-1){return}if(req.url.indexOf("/kcs/")!==-1){filePath=url.parse(req.url).pathname;fileAbsolutePath=""+global.appDataPath+filePath;util.guaranteeFilePath(fileAbsolutePath);return fs.writeFile(fileAbsolutePath,data,function(err){if(err!=null){return console.log(err)}else{if(!err){return console.log("Save Cache File: "+filePath)}}})}}}).call(this);